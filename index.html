<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Suite 2026 Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hide scrollbar for clean inputs */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }

        /* Ghost Input Animation */
        .input-ghost {
            transition: all 0.2s;
            border-bottom: 1px solid transparent;
        }
        .input-ghost:hover, .input-ghost:focus {
            background-color: #f1f5f9;
            border-bottom: 1px solid #cbd5e1;
            padding-left: 4px;
        }

        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- HEADER -->
    <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 shrink-0 z-30 sticky top-0 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-indigo-600 to-violet-600 text-white p-2 rounded-xl shadow-lg shadow-indigo-500/20">
                        <i data-lucide="layers" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900 leading-tight">Creative Suite</h1>
                        <p class="text-xs text-slate-500 font-medium">Planificaci√≥n 2026</p>
                    </div>
                </div>

                <!-- Stats Dashboard (Compact) -->
                <div class="flex gap-4 items-center overflow-x-auto pb-1 md:pb-0" id="stats-container">
                    <!-- Injected by JS -->
                </div>
            </div>

            <div class="mt-4 flex flex-col xl:flex-row gap-4 justify-between items-center border-t border-slate-100 pt-3">
                <div class="flex flex-col sm:flex-row gap-2 w-full xl:w-auto items-center">
                    <!-- Search -->
                    <div class="relative w-full sm:w-56 group">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="text" id="search-input" oninput="handleSearch(this.value)" 
                            class="block w-full pl-9 pr-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all" 
                            placeholder="Buscar...">
                    </div>
                    
                    <!-- Order By -->
                    <div class="relative w-full sm:w-auto">
                        <i data-lucide="arrow-up-down" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 w-3.5 h-3.5"></i>
                        <select id="sort-by" onchange="handleSort(this.value)" class="block pl-8 pr-8 py-1.5 text-sm bg-white border border-slate-200 rounded-lg focus:ring-indigo-500 outline-none cursor-pointer hover:bg-slate-50 w-full">
                            <option value="date">üìÖ Por Fecha</option>
                            <option value="recent">‚ú® Recientes</option>
                        </select>
                    </div>

                    <!-- Filters -->
                    <div class="flex gap-2 w-full sm:w-auto">
                        <select id="filter-area" onchange="handleFilterArea(this.value)" class="block px-3 py-1.5 text-sm bg-white border border-slate-200 rounded-lg focus:ring-indigo-500 outline-none cursor-pointer hover:bg-slate-50">
                            <option value="Todas">Todas las √Åreas</option>
                            <option value="Dise√±o">üé® Dise√±o</option>
                            <option value="AudioVisual">üé• Audiovisual</option>
                        </select>
                        
                        <select id="filter-priority" onchange="handleFilterPriority(this.value)" class="block px-3 py-1.5 text-sm bg-white border border-slate-200 rounded-lg focus:ring-indigo-500 outline-none cursor-pointer hover:bg-slate-50">
                            <option value="Todas">Prioridad</option>
                            <option value="Alta">üî¥ Alta</option>
                            <option value="Media">üü° Media</option>
                            <option value="Baja">üü¢ Baja</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3 items-center w-full sm:w-auto justify-between sm:justify-end">
                    
                    <!-- Zoom Control (Only visible in Grid View) -->
                    <div id="zoom-control" class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-200 rounded-lg mr-2">
                        <i data-lucide="zoom-out" class="w-3 h-3 text-slate-400"></i>
                        <input type="range" min="1" max="5" value="3" class="w-20 accent-indigo-600" oninput="handleZoom(this.value)" title="Zoom de tarjetas">
                        <i data-lucide="zoom-in" class="w-3 h-3 text-slate-400"></i>
                    </div>

                    <!-- View Switcher -->
                    <div class="flex bg-slate-100/80 p-1 rounded-lg border border-slate-200">
                        <button onclick="setView('grid')" id="btn-grid" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Tablero">
                            <i data-lucide="layout-grid" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setView('list')" id="btn-list" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Lista">
                            <i data-lucide="list" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setView('calendar')" id="btn-calendar" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Calendario">
                            <i data-lucide="calendar-days" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setView('gantt')" id="btn-gantt" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Gantt">
                            <i data-lucide="gantt-chart-square" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <button onclick="addNewTask()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-md hover:shadow-lg active:scale-95 whitespace-nowrap">
                        <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden lg:inline">Nueva Tarea</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden bg-slate-50 relative">
        <div id="app-container" class="max-w-7xl mx-auto h-full flex flex-col relative p-4 sm:p-6">
            <!-- Content Injected Here -->
        </div>
    </main>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="hidden fixed bg-white rounded-lg shadow-xl border border-slate-200 w-48 py-1.5 z-50 ring-1 ring-slate-900/5">
        <button onclick="duplicateTaskFromMenu()" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2.5 transition-colors">
            <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i> Duplicar tarea
        </button>
        <div class="h-px bg-slate-100 my-1"></div>
        <button onclick="deleteTaskFromMenu()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2.5 transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i> Eliminar tarea
        </button>
    </div>

    <script>
        // --- TOAST SYSTEM ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = type === 'success' ? 'bg-emerald-500' : 'bg-slate-800';
            const icon = type === 'success' ? 'check-circle' : 'info';
            
            toast.className = `toast-enter pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg shadow-slate-200 text-white text-sm font-medium ${colors} min-w-[300px]`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i> ${message}`;
            
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- DATA ---
        const INITIAL_TASKS = [
            // Enero
            { id: 1, area: 'AudioVisual', client: 'Scheckers', program: 'Video-c√°psula Enero', detail: 'Entrega segunda semana enero', date: '2026-01-06', duration: 7, priority: 'Alta', completed: false, createdAt: 1 },
            { id: 2, area: 'Dise√±o', client: 'Scheckers', program: 'Infograf√≠a Enero', detail: 'Entrega segunda semana enero', date: '2026-01-06', duration: 4, priority: 'Alta', completed: false, createdAt: 2 },
            { id: 3, area: 'Dise√±o', client: 'Metlife', program: 'BOOK Imprimible', detail: 'Ajustes de jota (Bordes) para impresi√≥n Tekkrom', date: '2026-01-20', duration: 5, priority: 'Alta', completed: false, createdAt: 3 },
            { id: 4, area: 'Dise√±o', client: 'Metlife', program: 'M√≥dulo VENTAS', detail: 'Nuevo Manual para Facilitadora Externa', date: '2026-01-26', duration: 7, priority: 'Alta', completed: false, createdAt: 4 },
            { id: 5, area: 'Dise√±o', client: 'Ripley', program: 'Pend√≥n Onboarding', detail: 'Pend√≥n gu√≠a centro formaci√≥n Ega√±a', date: '2026-01-12', duration: 3, priority: 'Alta', completed: false, createdAt: 5 },
            { id: 6, area: 'Dise√±o', client: 'Ripley', program: 'Poster Tienda', detail: 'Infograf√≠a esquema talleres presenciales', date: '2026-01-15', duration: 2, priority: 'Media', completed: false, createdAt: 6 },
            { id: 7, area: 'Dise√±o', client: 'Ripley', program: 'Infograf√≠a Jecyp', detail: 'Gu√≠a Jecyp buenas pr√°cticas', date: '2026-01-15', duration: 2, priority: 'Media', completed: false, createdAt: 7 },
            { id: 8, area: 'Dise√±o', client: 'Ripley', program: 'Fotos de Equipo', detail: 'Fotos profesionales para Presentaciones/Gifs', date: '2026-01-26', duration: 1, priority: 'Alta', completed: false, createdAt: 8 },
            { id: 9, area: 'AudioVisual', client: 'Ripley', program: 'Video Interactivo', detail: 'Guion uso Rposs (Conversar con JUAN)', date: '2026-01-31', duration: 5, priority: 'Media', completed: false, createdAt: 9 },
            { id: 10, area: 'Dise√±o', client: 'Walmart', program: 'Dise√±os Tem√°ticos', detail: 'Campa√±as WhatsApp (Pascua, 18, Halloween...)', date: '2026-03-01', duration: 5, priority: 'Baja', completed: false, createdAt: 10 },
            { id: 11, area: 'Dise√±o', client: 'Equipo XP', program: 'Saludo Clientes', detail: 'D√≠a madre, mujer, Navidad, etc.', date: '2026-02-01', duration: 3, priority: 'Baja', completed: false, createdAt: 11 },
            { id: 12, area: 'Dise√±o', client: 'Walmart', program: 'Testimonios Apertura', detail: 'Videos testimonios 2026', date: '2026-05-01', duration: 10, priority: 'Baja', completed: false, createdAt: 12 },
            { id: 13, area: 'Dise√±o', client: 'Walmart', program: 'Presentaciones', detail: 'Actualizaci√≥n dise√±o presentaciones apertura', date: '2026-01-31', duration: 5, priority: 'Baja', completed: false, createdAt: 13 },
            { id: 14, area: 'AudioVisual', client: 'Walmart', program: 'Testimonio OB', detail: 'Testimonio de experiencia', date: '2026-06-01', duration: 7, priority: 'Baja', completed: false, createdAt: 14 },
            { id: 15, area: 'AudioVisual', client: 'Walmart', program: 'Video Bienvenida', detail: 'Visualizaci√≥n del programa OB soporte', date: '2026-11-01', duration: 7, priority: 'Baja', completed: false, createdAt: 15 },
            { id: 16, area: 'AudioVisual', client: 'Parque R.', program: 'Video Impacto', detail: '1er semestre (movilizador) / 2do semestre (cierre)', date: '2026-07-01', duration: 10, priority: 'Baja', completed: false, createdAt: 16 },
            { id: 17, area: 'AudioVisual', client: 'Metlife', program: 'Video Impacto', detail: 'Video de cierre con testimonios', date: '2026-11-01', duration: 7, priority: 'Baja', completed: false, createdAt: 17 },
            { id: 18, area: 'Dise√±o', client: 'Ripley', program: 'GIFs Fechas', detail: 'Navidad, A√±o Nuevo, Fiestas Patrias', date: '2026-03-02', duration: 10, priority: 'Baja', completed: false, createdAt: 18 },
            { id: 19, area: 'AudioVisual', client: 'Ripley', program: 'Cierre Trimestre', detail: 'Video cierre indicadores (cada 3 meses)', date: '2026-04-03', duration: 5, priority: 'Baja', completed: false, createdAt: 19 },
            { id: 20, area: 'AudioVisual', client: 'Ripley', program: 'Impacto Semestral', detail: 'Motivacional / Cierre', date: '2026-05-29', duration: 5, priority: 'Baja', completed: false, createdAt: 20 },
            { id: 21, area: 'Dise√±o', client: 'Ripley', program: 'Galard√≥n Fin A√±o', detail: 'Dise√±o de reconocimiento tiendas', date: '2026-11-08', duration: 5, priority: 'Baja', completed: false, createdAt: 21 },
            { id: 22, area: 'AudioVisual', client: 'Ripley', program: 'Video Cierre A√±o', detail: 'Recopilaci√≥n entrega premios', date: '2026-12-04', duration: 7, priority: 'Baja', completed: false, createdAt: 22 },
            { id: 23, area: 'AudioVisual', client: 'Scheckers', program: 'C√°psula Febrero', detail: 'Entrega primera semana febrero', date: '2026-02-03', duration: 5, priority: 'Media', completed: false, createdAt: 23 },
            { id: 24, area: 'Dise√±o', client: 'Scheckers', program: 'Infograf√≠a Febrero', detail: 'Entrega primera semana febrero', date: '2026-02-03', duration: 3, priority: 'Media', completed: false, createdAt: 24 },
            { id: 25, area: 'Dise√±o', client: 'Walmart', program: 'Infograf√≠as OB', detail: 'Nuevo formato de entrenamiento', date: '2026-01-26', duration: 5, priority: 'Media', completed: false, createdAt: 25 },
            { id: 26, area: 'Dise√±o', client: 'Walmart', program: 'QR Tiendas', detail: 'Im√°genes QR para declaraci√≥n jurada', date: '2026-01-26', duration: 2, priority: 'Media', completed: false, createdAt: 26 },
            { id: 27, area: 'Dise√±o', client: 'Equipo XP', program: 'XP News', detail: 'Nuevo template newsletter', date: '2026-03-01', duration: 3, priority: 'Media', completed: false, createdAt: 27 },
            { id: 28, area: 'Dise√±o', client: 'Walmart', program: 'Estructura Procesos', detail: 'Revisi√≥n dise√±o flujograma', date: '2026-01-31', duration: 3, priority: 'Media', completed: false, createdAt: 28 },
            { id: 29, area: 'Dise√±o', client: 'Walmart', program: 'Videos Testimonios', detail: 'Dise√±o gr√°fica testimonios 2025', date: '2026-02-01', duration: 4, priority: 'Media', completed: false, createdAt: 29 },
            { id: 30, area: 'Dise√±o', client: 'Walmart', program: 'Videos APT', detail: 'Dise√±o testimonios e hitos', date: '2026-02-01', duration: 4, priority: 'Media', completed: false, createdAt: 30 },
            { id: 31, area: 'Dise√±o', client: 'Equipo XP', program: 'Taller DEI', detail: 'Dise√±o presentaci√≥n Diversidad e Inclusi√≥n', date: '2026-03-02', duration: 5, priority: 'Media', completed: false, createdAt: 31 },
            { id: 32, area: 'Dise√±o', client: 'Equipo XP', program: 'Infograf√≠a DJ', detail: 'Instructivo DJ Elearning', date: '2026-02-15', duration: 3, priority: 'Media', completed: false, createdAt: 32 },
            { id: 33, area: 'AudioVisual', client: 'Equipo XP', program: 'Video DJ', detail: 'Video corto instructivo DJ', date: '2026-02-15', duration: 4, priority: 'Media', completed: false, createdAt: 33 },
            { id: 34, area: 'Dise√±o', client: 'Equipo XP', program: 'Template Cowork', detail: 'Renovar nueva cara del a√±o', date: '2026-02-15', duration: 3, priority: 'Baja', completed: false, createdAt: 34 },
            { id: 35, area: 'AudioVisual', client: 'Equipo XP', program: 'Web / Redes', detail: 'Renovar videos equipo y web', date: '2026-06-01', duration: 10, priority: 'Baja', completed: false, createdAt: 35 },
            { id: 36, area: 'AudioVisual', client: 'Ripley', program: 'Impacto Anual', detail: 'Video cierre programa, material recopilatorio', date: '2026-11-01', duration: 7, priority: 'Baja', completed: false, createdAt: 36 }
        ];

        let tasks = JSON.parse(localStorage.getItem('creativeTasks_2026_v5')) || INITIAL_TASKS;
        if(tasks.length < 5) tasks = INITIAL_TASKS;

        let state = {
            view: 'grid',
            filterArea: 'Todas',
            filterPriority: 'Todas',
            searchTerm: '',
            sortBy: 'date', // date, recent
            zoomLevel: 3, // 1 to 5
            calendarDate: new Date(2026, 0, 1),
            activeMenuTaskId: null
        };

        const saveTasks = () => localStorage.setItem('creativeTasks_2026_v5', JSON.stringify(tasks));

        // --- HELPERS ---
        const addDays = (dateStr, days) => {
            const date = new Date(dateStr + 'T12:00:00');
            date.setDate(date.getDate() + parseInt(days));
            return date.toISOString().split('T')[0];
        };

        const getDaysDiff = (startStr, endStr) => {
            const d1 = new Date(startStr + 'T12:00:00');
            const d2 = new Date(endStr + 'T12:00:00');
            const diffTime = d2 - d1;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays > 0 ? diffDays : 1; 
        };

        const getPriorityColor = (p) => {
            if(p === 'Alta') return 'bg-rose-50 text-rose-700 border-rose-100 ring-1 ring-rose-200';
            if(p === 'Media') return 'bg-amber-50 text-amber-700 border-amber-100 ring-1 ring-amber-200';
            return 'bg-emerald-50 text-emerald-700 border-emerald-100 ring-1 ring-emerald-200';
        };

        const getClientColor = (c) => {
            const safeClient = c || 'General';
            if(safeClient.includes('Ripley')) return 'bg-violet-600';
            if(safeClient.includes('Walmart')) return 'bg-blue-600';
            if(safeClient.includes('Metlife')) return 'bg-sky-500';
            if(safeClient.includes('Scheckers')) return 'bg-indigo-500';
            if(safeClient.includes('Parque')) return 'bg-emerald-600';
            if(safeClient.includes('XP')) return 'bg-pink-500';
            return 'bg-slate-500';
        };

        const getClientBadge = (c) => {
            const safeClient = c || 'General';
            if(safeClient.includes('Ripley')) return 'bg-violet-50 text-violet-700 ring-1 ring-violet-200';
            if(safeClient.includes('Walmart')) return 'bg-blue-50 text-blue-700 ring-1 ring-blue-200';
            if(safeClient.includes('Metlife')) return 'bg-sky-50 text-sky-700 ring-1 ring-sky-200';
            if(safeClient.includes('Scheckers')) return 'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200';
            if(safeClient.includes('Parque')) return 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200';
            if(safeClient.includes('XP')) return 'bg-pink-50 text-pink-700 ring-1 ring-pink-200';
            return 'bg-slate-100 text-slate-700 ring-1 ring-slate-200';
        };

        const getFilteredTasks = () => {
            const filtered = tasks.filter(t => {
                const matchArea = state.filterArea === 'Todas' || t.area === state.filterArea;
                const matchPriority = state.filterPriority === 'Todas' || t.priority === state.filterPriority;
                const search = state.searchTerm.toLowerCase();
                const safeClient = (t.client || '').toLowerCase();
                const safeProgram = (t.program || '').toLowerCase();
                const safeDetail = (t.detail || '').toLowerCase();
                
                const matchSearch = safeClient.includes(search) || 
                                    safeProgram.includes(search) || 
                                    safeDetail.includes(search);
                return matchArea && matchPriority && matchSearch;
            });

            if (state.sortBy === 'recent') {
                return filtered.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
            } else {
                return filtered.sort((a,b) => new Date(a.date) - new Date(b.date));
            }
        };

        // --- RENDERERS ---
        function renderApp() {
            renderHeader();
            const container = document.getElementById('app-container');
            container.innerHTML = ''; 

            const filtered = getFilteredTasks();
            
            // Toggle Zoom Control Visibility
            const zoomControl = document.getElementById('zoom-control');
            if (state.view === 'grid') {
                zoomControl.classList.remove('hidden');
                zoomControl.classList.add('flex');
            } else {
                zoomControl.classList.add('hidden');
                zoomControl.classList.remove('flex');
            }

            if(filtered.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-400 opacity-60">
                        <i data-lucide="ghost" class="w-16 h-16 mb-4"></i>
                        <p class="text-lg font-medium">No se encontraron tareas</p>
                    </div>`;
            } else {
                if (state.view === 'grid') renderGrid(container, filtered);
                else if (state.view === 'list') renderList(container, filtered);
                else if (state.view === 'calendar') renderCalendar(container, filtered);
                else if (state.view === 'gantt') renderGantt(container, filtered);
            }

            lucide.createIcons();
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                btn.classList.add('text-slate-500', 'hover:bg-slate-200');
            });
            const activeBtn = document.getElementById(`btn-${state.view}`);
            activeBtn.classList.remove('text-slate-500', 'hover:bg-slate-200');
            activeBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            
            // Update Sort Selector UI
            document.getElementById('sort-by').value = state.sortBy;
        }

        function renderHeader() {
            const filtered = getFilteredTasks();
            const total = filtered.length;
            const alta = filtered.filter(t => t.priority === 'Alta').length;
            const diseno = filtered.filter(t => t.area === 'Dise√±o').length;
            const av = filtered.filter(t => t.area === 'AudioVisual').length;

            const createStat = (label, value, icon, color) => `
                <div class="flex items-center gap-3 px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl min-w-[140px]">
                    <div class="p-2 rounded-lg ${color} text-white shadow-sm">
                        <i data-lucide="${icon}" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 font-medium uppercase tracking-wide">${label}</div>
                        <div class="text-lg font-bold text-slate-800 leading-none">${value}</div>
                    </div>
                </div>
            `;

            document.getElementById('stats-container').innerHTML = `
                ${createStat('Total', total, 'list-todo', 'bg-slate-800')}
                ${createStat('Cr√≠ticas', alta, 'alert-circle', 'bg-rose-500')}
                ${createStat('Dise√±o', diseno, 'palette', 'bg-indigo-500')}
                ${createStat('Video', av, 'video', 'bg-orange-500')}
            `;
        }

        function renderGrid(container, tasks) {
            container.className = "max-w-7xl mx-auto h-full flex flex-col";
            const gridDiv = document.createElement('div');
            
            // Grid Cols Logic based on Zoom Level
            let gridCols = "grid-cols-1 md:grid-cols-3"; // Default
            const z = parseInt(state.zoomLevel);
            if(z === 1) gridCols = "grid-cols-1";
            if(z === 2) gridCols = "grid-cols-1 sm:grid-cols-2";
            if(z === 3) gridCols = "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3";
            if(z === 4) gridCols = "grid-cols-1 sm:grid-cols-2 lg:grid-cols-4";
            if(z === 5) gridCols = "grid-cols-2 sm:grid-cols-3 lg:grid-cols-5";

            gridDiv.className = `grid gap-6 overflow-y-auto pb-20 ${gridCols} pr-2 custom-scrollbar content-start flex-1 w-full`;
            
            tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = "group bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-indigo-100 hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden relative min-h-[200px]";
                
                // Highlight new tasks in "Recent" sort
                if (state.sortBy === 'recent' && (Date.now() - task.createdAt) < 60000) {
                    card.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
                }

                card.innerHTML = `
                    <div class="h-1.5 w-full ${getClientColor(task.client)}"></div>
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-3">
                             <div class="flex items-center gap-2">
                                <span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold ${getPriorityColor(task.priority)}">${task.priority}</span>
                                ${task.completed ? '<i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-500"></i>' : ''}
                             </div>
                             <div class="bg-slate-50 p-1.5 rounded-lg border border-slate-100 group-hover:bg-white group-hover:shadow-sm transition-all">
                                 <i data-lucide="${task.area === 'Dise√±o' ? 'palette' : 'video'}" class="w-3.5 h-3.5 text-slate-400 group-hover:text-indigo-500"></i>
                             </div>
                        </div>
                        
                        <div class="flex-1">
                            <h3 class="text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1 flex items-center gap-1">
                                ${task.client || 'General'}
                            </h3>
                            <h2 class="text-base font-bold text-slate-800 leading-snug mb-2 group-hover:text-indigo-600 transition-colors line-clamp-2">${task.program}</h2>
                            <p class="text-xs text-slate-500 leading-relaxed line-clamp-3">${task.detail || ''}</p>
                        </div>

                        <div class="flex items-center justify-between text-xs text-slate-400 mt-4 pt-4 border-t border-slate-50">
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 text-indigo-400"></i> 
                                <span class="font-medium text-slate-600">${new Date(task.date + 'T12:00:00').toLocaleDateString('es-CL')}</span>
                            </div>
                            <span class="font-medium bg-slate-50 px-2 py-0.5 rounded text-slate-500">${task.duration} d√≠as</span>
                        </div>
                    </div>
                `;
                gridDiv.appendChild(card);
            });
            container.appendChild(gridDiv);
        }

        function renderList(container, tasks) {
            container.className = "max-w-7xl mx-auto h-full flex flex-col";
            const listDiv = document.createElement('div');
            listDiv.className = "flex flex-col gap-3 overflow-y-auto pb-20 pr-2 custom-scrollbar flex-1 w-full";
            
            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = "group bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-indigo-200 transition-all flex flex-row items-center h-20 overflow-hidden shrink-0";
                item.innerHTML = `
                    <div class="w-1.5 h-full ${getClientColor(task.client)}"></div>
                    <div class="p-4 flex-1 flex flex-row items-center justify-between gap-6">
                        
                        <div class="w-8 flex justify-center">
                             <button onclick="toggleComplete(${task.id})" class="text-slate-300 hover:text-emerald-500 hover:scale-110 transition-all">
                                <i data-lucide="check-circle-2" class="w-5 h-5" ${task.completed ? 'fill="#10b981" stroke="white"' : ''}></i>
                             </button>
                        </div>

                        <div class="min-w-[80px]">
                            <span class="px-2.5 py-1 rounded-full text-[10px] font-bold ${getPriorityColor(task.priority)}">${task.priority}</span>
                        </div>
                        
                        <div class="flex-1 min-w-[200px]">
                            <h3 class="text-[10px] font-bold uppercase text-slate-400 mb-0.5">${task.client || 'General'}</h3>
                            <input type="text" value="${task.program}" onchange="updateTask(${task.id}, 'program', this.value)" 
                                class="w-full text-sm font-bold text-slate-800 bg-transparent input-ghost rounded px-1 -ml-1 ${task.completed ? 'line-through text-slate-400' : ''}">
                        </div>

                        <div class="hidden md:flex flex-1 items-center gap-2">
                             <span class="flex items-center w-fit text-[11px] font-medium text-slate-600 bg-slate-50 px-2.5 py-1 rounded-lg border border-slate-100">
                                <i data-lucide="${task.area === 'Dise√±o' ? 'palette' : 'video'}" class="w-3 h-3 mr-1.5 text-slate-400"></i>
                                ${task.area}
                            </span>
                        </div>
                        
                        <div class="text-right min-w-[120px]">
                            <div class="flex items-center justify-end text-xs font-medium text-slate-600 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100 group-hover:bg-white group-hover:shadow-sm transition-all">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 mr-2 text-indigo-500"></i> ${new Date(task.date + 'T12:00:00').toLocaleDateString('es-CL', {day: 'numeric', month:'short'})}
                            </div>
                        </div>

                        <div class="w-8 flex justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                             <button onclick="openContextMenu(event, ${task.id})" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
                listDiv.appendChild(item);
            });
            container.appendChild(listDiv);
        }

        function renderCalendar(container, tasks) {
            container.className = "max-w-7xl mx-auto h-full flex flex-col";
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            const wrapper = document.createElement('div');
            wrapper.className = "bg-white rounded-xl shadow-sm border border-slate-200 h-full flex flex-col overflow-hidden";

            const header = document.createElement('div');
            header.className = "p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50";
            header.innerHTML = `
                <div class="flex items-center bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
                    <button onclick="changeMonth(-1)" class="p-1.5 hover:bg-slate-50 rounded-md text-slate-500 hover:text-indigo-600 transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span class="px-4 text-sm font-bold text-slate-800 w-40 text-center select-none uppercase tracking-wide">
                        ${monthNames[state.calendarDate.getMonth()]} <span class="text-slate-400">${state.calendarDate.getFullYear()}</span>
                    </span>
                    <button onclick="changeMonth(1)" class="p-1.5 hover:bg-slate-50 rounded-md text-slate-500 hover:text-indigo-600 transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            `;
            wrapper.appendChild(header);

            const gridHeader = document.createElement('div');
            gridHeader.className = "grid grid-cols-7 border-b border-slate-200 bg-slate-50 sticky top-0 z-10";
            ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'].forEach(d => {
                gridHeader.innerHTML += `<div class="py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-widest">${d}</div>`;
            });
            
            const gridBody = document.createElement('div');
            gridBody.className = "grid grid-cols-7 auto-rows-fr flex-1 overflow-y-auto custom-scrollbar min-h-0 bg-slate-50/30";
            wrapper.appendChild(gridHeader);
            wrapper.appendChild(gridBody);

            const year = state.calendarDate.getFullYear();
            const month = state.calendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let startingDay = firstDay.getDay() - 1; 
            if (startingDay === -1) startingDay = 6;
            
            const totalSlots = 42; 
            let dayCounter = 1;

            for (let i = 0; i < totalSlots; i++) {
                const cell = document.createElement('div');
                cell.className = "min-h-[120px] border-b border-r border-slate-100/80 p-1.5 flex flex-col gap-1 transition-colors hover:bg-white";
                
                if (i >= startingDay && dayCounter <= lastDay.getDate()) {
                    let d = dayCounter;
                    let mStr = (month + 1).toString().padStart(2, '0');
                    let dStr = d.toString().padStart(2, '0');
                    let dateStr = `${year}-${mStr}-${dStr}`;
                    
                    const isToday = dateStr === new Date().toISOString().split('T')[0];

                    cell.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'text-slate-700'}">${d}</span>
                        </div>`;
                    
                    const dayTasks = tasks.filter(t => t.date === dateStr);
                    dayTasks.forEach(t => {
                        const bg = getClientColor(t.client);
                        cell.innerHTML += `
                            <div class="group relative text-[10px] px-2 py-1 rounded-md shadow-sm text-white ${bg} cursor-pointer hover:brightness-110 transition-all font-medium truncate" title="${t.program}">
                                ${t.completed ? '<i data-lucide="check" class="w-3 h-3 inline mr-1"></i>' : ''} ${t.program}
                            </div>`;
                    });
                    
                    if(isToday) cell.classList.add('bg-indigo-50/30');
                    dayCounter++;
                } else {
                    cell.classList.add("bg-slate-50/50");
                }
                gridBody.appendChild(cell);
            }
            container.appendChild(wrapper);
        }

        function renderGantt(container, filteredTasks) {
            container.className = "max-w-7xl mx-auto h-full flex flex-col gap-4 pb-10";
            
            // Editor
            const editorDiv = document.createElement('div');
            editorDiv.className = "bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative z-10 h-[40%] min-h-[300px]";
            
            editorDiv.innerHTML = `
                <div class="px-5 py-3 bg-slate-50 border-b border-slate-200 font-semibold text-slate-700 text-sm flex items-center gap-2">
                    <i data-lucide="table-2" class="w-4 h-4 text-slate-400"></i> Editor de Tareas
                </div>
                <div class="grid grid-cols-[40px_140px_1fr_110px_70px_110px_40px] bg-slate-50/50 font-bold border-b border-slate-200 text-slate-500 text-[10px] uppercase tracking-wider h-[40px] items-center shrink-0">
                    <div class="border-r border-slate-200 h-full flex items-center justify-center">#</div>
                    <div class="px-3 border-r border-slate-200 h-full flex items-center">Cliente</div>
                    <div class="px-3 border-r border-slate-200 h-full flex items-center">Programa</div>
                    <div class="px-1 border-r border-slate-200 h-full flex items-center justify-center">Inicio</div>
                    <div class="px-1 border-r border-slate-200 h-full flex items-center justify-center">D√≠as</div>
                    <div class="px-1 h-full flex items-center justify-center">Fin</div>
                    <div class="h-full"></div>
                </div>
            `;
            
            const editorBody = document.createElement('div');
            editorBody.className = "overflow-y-auto flex-1 bg-white custom-scrollbar";
            
            filteredTasks.forEach(task => {
                const endDate = addDays(task.date, task.duration);
                const row = document.createElement('div');
                row.className = `grid grid-cols-[40px_140px_1fr_110px_70px_110px_40px] border-b border-slate-100 hover:bg-slate-50 transition-colors items-center h-[44px] group ${task.completed ? 'bg-slate-50/50' : ''}`;
                
                row.innerHTML = `
                    <div class="border-r border-slate-100 h-full flex items-center justify-center">
                        <button onclick="toggleComplete(${task.id})" class="text-slate-300 hover:text-emerald-500 hover:scale-110 transition-transform">
                            <i data-lucide="check-circle-2" class="w-4 h-4" ${task.completed ? 'fill="#10b981" stroke="white"' : ''}></i>
                        </button>
                    </div>
                    <div class="border-r border-slate-100 h-full px-2 py-1 flex items-center ${task.completed ? 'opacity-50 grayscale' : ''}">
                         <div class="w-full h-7 px-2 rounded-md flex items-center justify-center text-[10px] font-bold truncate ${getClientBadge(task.client)}">
                             ${task.client || 'General'}
                         </div>
                    </div>
                    <div class="border-r border-slate-100 h-full px-3 py-1 flex items-center ${task.completed ? 'opacity-50 line-through text-slate-400' : ''}">
                        <input type="text" value="${task.program}" onchange="updateTask(${task.id}, 'program', this.value)" 
                            class="w-full text-xs font-semibold text-slate-700 bg-transparent input-ghost rounded py-1 px-2">
                    </div>
                    <div class="border-r border-slate-100 h-full px-1 py-1 flex items-center justify-center relative hover:bg-slate-100 transition-colors cursor-pointer group-input">
                        <input type="date" value="${task.date}" oninput="updateTask(${task.id}, 'date', this.value)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <span class="text-xs font-mono text-slate-600 pointer-events-none group-input-hover:text-indigo-600">${task.date}</span>
                    </div>
                    <div class="border-r border-slate-100 h-full px-1 py-1 flex items-center justify-center">
                        <input type="number" min="1" value="${task.duration}" onchange="updateTask(${task.id}, 'duration', this.value)" class="w-full bg-transparent border-none outline-none text-center text-xs font-mono text-slate-600 input-ghost rounded">
                    </div>
                    <div class="h-full px-1 py-1 flex items-center justify-center relative hover:bg-slate-100 cursor-pointer">
                        <input type="date" value="${endDate}" oninput="updateEnd(${task.id}, '${task.date}', this.value)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <span class="text-xs font-mono text-slate-500 pointer-events-none">${endDate}</span>
                    </div>
                    <div class="h-full flex items-center justify-center">
                        <button onclick="openContextMenu(event, ${task.id})" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100">
                            <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                editorBody.appendChild(row);
            });
            editorDiv.appendChild(editorBody);
            container.appendChild(editorDiv);

            // Visual Timeline
            const visualDiv = document.createElement('div');
            visualDiv.className = "bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col flex-1 overflow-hidden relative z-0 min-h-[300px]";
            visualDiv.innerHTML = `<div class="px-5 py-3 bg-slate-50 border-b border-slate-200 font-semibold text-slate-700 text-sm flex items-center gap-2 shrink-0"><i data-lucide="bar-chart-3" class="w-4 h-4 text-slate-400"></i> Cronograma Visual</div>`;

            const flexContainer = document.createElement('div');
            flexContainer.className = "flex flex-1 overflow-hidden";
            
            const leftLabels = document.createElement('div');
            leftLabels.className = "w-48 flex-shrink-0 border-r border-slate-200 bg-white z-20 shadow-[4px_0_10px_-4px_rgba(0,0,0,0.05)] flex flex-col";
            leftLabels.innerHTML = `<div class="h-[40px] border-b border-slate-200 bg-slate-50 flex items-center px-4 text-[10px] uppercase tracking-wider text-slate-500 font-bold shrink-0">Referencia</div>`;
            const labelBody = document.createElement('div');
            labelBody.className = "overflow-hidden flex-1 bg-white pt-0";
            filteredTasks.forEach(task => {
                labelBody.innerHTML += `
                    <div class="border-b border-slate-100 px-4 flex items-center text-xs font-medium text-slate-600 hover:bg-slate-50 transition-colors h-[44px]">
                        <div class="w-2 h-2 rounded-full mr-3 shrink-0 ${getClientColor(task.client).split(' ')[0]} shadow-sm"></div>
                        <span class="truncate ${task.completed ? 'text-slate-400 line-through' : ''}">${task.program || '(Sin nombre)'}</span>
                    </div>`;
            });
            leftLabels.appendChild(labelBody);

            const timestamps = filteredTasks.map(t => new Date(t.date + 'T12:00:00').getTime());
            const minTs = Math.min(...timestamps);
            const maxTs = Math.max(...filteredTasks.map(t => new Date(addDays(t.date, t.duration) + 'T12:00:00').getTime()));
            
            const startBuffer = new Date(minTs); startBuffer.setDate(startBuffer.getDate() - 5);
            const endBuffer = new Date(maxTs); endBuffer.setDate(endBuffer.getDate() + 30);

            const timelineDays = [];
            let curr = new Date(startBuffer);
            while (curr <= endBuffer) {
                timelineDays.push(new Date(curr));
                curr.setDate(curr.getDate() + 1);
            }
            
            const DAY_WIDTH = 44;
            const timelineDiv = document.createElement('div');
            timelineDiv.className = "flex-1 flex flex-col overflow-hidden relative bg-white";
            
            const scroller = document.createElement('div');
            scroller.className = "flex-1 overflow-auto bg-slate-50 relative scroll-smooth custom-scrollbar";
            
            const contentWidth = timelineDays.length * DAY_WIDTH;
            const contentInner = document.createElement('div');
            contentInner.className = "relative min-h-full";
            contentInner.style.width = `${contentWidth}px`;

            const timeHeader = document.createElement('div');
            timeHeader.className = "sticky top-0 z-30 flex border-b border-slate-200 bg-white h-[40px] shadow-sm";
            timelineDays.forEach(d => {
                const isToday = d.toDateString() === new Date().toDateString();
                const dStr = d.toLocaleDateString('es-CL', {weekday:'narrow'});
                const dayNum = d.getDate();
                timeHeader.innerHTML += `
                    <div class="flex-shrink-0 border-r border-slate-100 flex flex-col justify-center items-center text-[10px] ${isToday ? 'bg-indigo-50 text-indigo-600 border-b-2 border-b-indigo-500 font-bold' : 'text-slate-400'}" style="width: ${DAY_WIDTH}px">
                        <span class="uppercase opacity-70 text-[9px] leading-tight">${dStr}</span>
                        <span class="text-xs leading-tight">${dayNum}</span>
                    </div>`;
            });
            contentInner.appendChild(timeHeader);

            const gridBg = document.createElement('div');
            gridBg.className = "absolute inset-0 top-[40px] flex pointer-events-none h-full";
            timelineDays.forEach((d) => {
                const isToday = d.toDateString() === new Date().toDateString();
                gridBg.innerHTML += `<div class="h-full border-r border-slate-100 box-border flex justify-center ${isToday ? 'bg-indigo-50/20' : ''}" style="width: ${DAY_WIDTH}px">
                     ${isToday ? '<div class="w-px h-full bg-indigo-400/50 absolute"></div>' : ''}
                </div>`;
            });
            contentInner.appendChild(gridBg);

            const barsContainer = document.createElement('div');
            barsContainer.className = "relative z-10";
            const ganttStartTs = startBuffer.getTime();

            filteredTasks.forEach(task => {
                const taskStart = new Date(task.date + 'T12:00:00').getTime();
                const diffTime = taskStart - ganttStartTs;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const left = diffDays * DAY_WIDTH;
                const width = task.duration * DAY_WIDTH;
                
                const colorClass = task.completed ? 'bg-slate-300 text-slate-500 ring-slate-300' : `${getClientBadge(task.client).split(' ')[0]} ${getClientBadge(task.client).split(' ')[1]} ring-white/50`;

                barsContainer.innerHTML += `
                    <div class="w-full relative border-b border-slate-100/50 hover:bg-indigo-50/10 transition-colors h-[44px]">
                        <div class="absolute top-1/2 -translate-y-1/2 h-7 rounded-md shadow-sm border border-white/20 ring-1 text-xs flex items-center px-2 whitespace-nowrap overflow-hidden transition-all cursor-pointer hover:shadow-md hover:scale-[1.01] ${colorClass}" 
                             style="left: ${left+2}px; width: ${width-4}px;" title="${task.program}">
                             ${width > 30 ? `<span class="font-bold text-[10px] truncate drop-shadow-sm">${task.program}</span>` : ''}
                        </div>
                    </div>`;
            });
            contentInner.appendChild(barsContainer);

            scroller.appendChild(contentInner);
            timelineDiv.appendChild(scroller);
            flexContainer.appendChild(leftLabels);
            flexContainer.appendChild(timelineDiv);
            visualDiv.appendChild(flexContainer);
            container.appendChild(visualDiv);
        }

        function setView(mode) {
            state.view = mode;
            renderApp();
        }
        function handleSearch(val) { state.searchTerm = val; renderApp(); }
        function handleFilterArea(val) { state.filterArea = val; renderApp(); }
        function handleFilterPriority(val) { state.filterPriority = val; renderApp(); }
        function handleSort(val) { state.sortBy = val; renderApp(); }
        function handleZoom(val) { state.zoomLevel = parseInt(val); renderApp(); }

        function addNewTask() {
            const newTask = {
                id: Date.now(),
                area: 'Dise√±o',
                client: 'Nuevo Cliente',
                program: 'Nueva Tarea',
                detail: 'Detalle de la tarea...',
                date: new Date().toISOString().split('T')[0],
                duration: 3,
                priority: 'Media',
                completed: false,
                createdAt: Date.now()
            };
            tasks.push(newTask);
            saveTasks();
            
            // Auto switch to 'recent' sort to show the new task
            state.sortBy = 'recent';
            renderApp();
            showToast('Tarea creada exitosamente');
        }

        window.updateTask = function(id, field, value) {
            const task = tasks.find(t => t.id === id);
            if(task) {
                task[field] = value;
                saveTasks();
                if(state.view !== 'gantt' || field === 'program') renderApp();
                showToast('Cambios guardados', 'success');
            }
        };

        window.updateEnd = function(id, startDate, endDate) {
            const diff = getDaysDiff(startDate, endDate);
            updateTask(id, 'duration', diff);
        };

        window.toggleComplete = function(id) {
            const task = tasks.find(t => t.id === id);
            if(task) {
                task.completed = !task.completed;
                saveTasks();
                renderApp();
                if(task.completed) showToast('¬°Tarea completada!', 'success');
            }
        };

        window.changeMonth = function(dir) {
            state.calendarDate.setMonth(state.calendarDate.getMonth() + dir);
            renderApp();
        };

        window.openContextMenu = function(e, id) {
            e.stopPropagation();
            state.activeMenuTaskId = id;
            const menu = document.getElementById('context-menu');
            const rect = e.target.getBoundingClientRect();
            menu.style.top = `${rect.bottom + window.scrollY}px`;
            menu.style.left = `${rect.left - 150}px`; 
            menu.classList.remove('hidden');
        };

        window.duplicateTaskFromMenu = function() {
            const task = tasks.find(t => t.id === state.activeMenuTaskId);
            if(task) {
                const newTask = {...task, id: Date.now(), program: task.program + ' (Copia)', createdAt: Date.now()};
                tasks.push(newTask);
                saveTasks();
                state.sortBy = 'recent'; // Switch to recent to show copy
                renderApp();
                showToast('Tarea duplicada');
            }
        };

        window.deleteTaskFromMenu = function() {
            if(confirm('¬øEst√°s seguro de eliminar esta tarea?')) {
                tasks = tasks.filter(t => t.id !== state.activeMenuTaskId);
                saveTasks();
                renderApp();
                showToast('Tarea eliminada', 'info');
            }
        };

        document.addEventListener('click', () => {
            document.getElementById('context-menu').classList.add('hidden');
        });

        renderApp();
    </script>
</body>
</html>
