<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Suite XP 2026 Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hide scrollbar for clean inputs */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }

        /* Ghost Input Animation */
        .input-ghost {
            transition: all 0.2s;
            border-bottom: 1px solid transparent;
        }
        .input-ghost:hover, .input-ghost:focus {
            background-color: #f1f5f9;
            border-bottom: 1px solid #cbd5e1;
            padding-left: 4px;
        }

        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Modal Animation */
        .modal-enter { opacity: 1 !important; }
        .modal-content-enter { transform: scale(1) !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- HEADER -->
    <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 shrink-0 z-30 sticky top-0 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-indigo-600 to-violet-600 text-white p-2 rounded-xl shadow-lg shadow-indigo-500/20">
                        <i data-lucide="layers" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-600 leading-tight">Creative XP</h1>
                        <p class="text-xs text-slate-500 font-medium">Planificaci√≥n 2026</p>
                    </div>
                </div>

                <!-- Stats Dashboard -->
                <div class="flex gap-4 items-center overflow-x-auto pb-1 md:pb-0" id="stats-container"></div>
            </div>

            <div class="mt-4 flex flex-col xl:flex-row gap-4 justify-between items-center border-t border-slate-100 pt-3">
                <div class="flex flex-col sm:flex-row gap-2 w-full xl:w-auto items-center">
                    <!-- Search -->
                    <div class="relative w-full sm:w-56 group">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="text" id="search-input" oninput="handleSearch(this.value)" 
                            class="block w-full pl-9 pr-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all" 
                            placeholder="Buscar...">
                    </div>
                    
                    <!-- Order By -->
                    <div class="relative w-full sm:w-auto">
                        <i data-lucide="arrow-up-down" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 w-3.5 h-3.5"></i>
                        <select id="sort-by" onchange="handleSort(this.value)" class="block pl-8 pr-8 py-1.5 text-sm bg-white border border-slate-200 rounded-lg focus:ring-indigo-500 outline-none cursor-pointer hover:bg-slate-50 w-full">
                            <option value="date">üìÖ Por Fecha</option>
                            <option value="recent">‚ú® Recientes</option>
                        </select>
                    </div>

                    <!-- Filters -->
                    <div class="flex gap-2 w-full sm:w-auto">
                        <select id="filter-area" onchange="handleFilterArea(this.value)" class="block px-3 py-1.5 text-sm bg-white border border-slate-200 rounded-lg focus:ring-indigo-500 outline-none cursor-pointer hover:bg-slate-50">
                            <option value="Todas">Todas las √Åreas</option>
                            <option value="Dise√±o">üé® Dise√±o</option>
                            <option value="AudioVisual">üé• Audiovisual</option>
                        </select>
                        
                        <select id="filter-priority" onchange="handleFilterPriority(this.value)" class="block px-3 py-1.5 text-sm bg-white border border-slate-200 rounded-lg focus:ring-indigo-500 outline-none cursor-pointer hover:bg-slate-50">
                            <option value="Todas">Prioridad</option>
                            <option value="Alta">üî¥ Alta</option>
                            <option value="Media">üü° Media</option>
                            <option value="Baja">üü¢ Baja</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3 items-center w-full sm:w-auto justify-between sm:justify-end">
                    
                    <!-- Zoom Control -->
                    <div id="zoom-control" class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-200 rounded-lg mr-2">
                        <i data-lucide="zoom-out" class="w-3 h-3 text-slate-400"></i>
                        <input type="range" min="1" max="5" value="3" class="w-20 accent-indigo-600" oninput="handleZoom(this.value)" title="Zoom de tarjetas">
                        <i data-lucide="zoom-in" class="w-3 h-3 text-slate-400"></i>
                    </div>

                    <!-- View Switcher -->
                    <div class="flex bg-slate-100/80 p-1 rounded-lg border border-slate-200">
                        <button onclick="setView('grid')" id="btn-grid" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Tablero">
                            <i data-lucide="layout-grid" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setView('list')" id="btn-list" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Lista">
                            <i data-lucide="list" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setView('calendar')" id="btn-calendar" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Calendario">
                            <i data-lucide="calendar-days" class="w-4 h-4"></i>
                        </button>
                        <button onclick="setView('gantt')" id="btn-gantt" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700" title="Vista Gantt">
                            <i data-lucide="gantt-chart-square" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <button onclick="openTaskModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-md hover:shadow-lg active:scale-95 whitespace-nowrap">
                        <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden lg:inline">Nueva Tarea</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto bg-slate-50 relative custom-scrollbar">
        <div id="app-container" class="max-w-7xl mx-auto flex flex-col relative p-4 sm:p-6 pb-20">
            <!-- Content Injected Here -->
        </div>
    </main>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- CREATE/EDIT TASK MODAL -->
    <div id="task-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-95 transition-transform duration-200" id="task-modal-content">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2" id="modal-title">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Nueva Tarea
                </h3>
                <button onclick="closeTaskModal()" class="text-slate-400 hover:text-red-500 transition-colors bg-white rounded-full p-1 hover:bg-red-50">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-5">
                <!-- Hidden Input for Editing ID -->
                <input type="hidden" id="modal-task-id">

                <!-- Row 1: Client & Area -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Cliente</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1" id="client-select-container">
                                <select id="modal-client" class="w-full border border-slate-200 rounded-lg pl-3 pr-8 py-2.5 text-sm font-medium text-slate-700 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all appearance-none cursor-pointer">
                                    <!-- Populated by JS -->
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                            </div>
                            <input type="text" id="modal-new-client" class="hidden w-full border border-slate-200 rounded-lg px-3 py-2.5 text-sm font-medium text-slate-700 bg-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Nombre cliente...">
                            <button onclick="toggleNewClient()" class="p-2 bg-slate-100 hover:bg-indigo-100 text-slate-500 hover:text-indigo-600 rounded-lg transition-colors border border-slate-200" title="Nuevo Cliente">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">√Årea</label>
                        <div class="relative">
                            <select id="modal-area" class="w-full border border-slate-200 rounded-lg pl-3 pr-8 py-2.5 text-sm font-medium text-slate-700 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all appearance-none cursor-pointer">
                                <option value="Dise√±o">üé® Dise√±o</option>
                                <option value="AudioVisual">üé• AudioVisual</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <!-- Row 1.5: Program Type (Subdivision) -->
                <div class="space-y-1.5">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Programa (Sub)</label>
                    <div class="relative">
                        <input type="text" id="modal-program-type" list="program-types-list" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="Ej: Onboarding, Apertura... (Opcional)">
                        <datalist id="program-types-list">
                            <!-- Populated by JS -->
                        </datalist>
                    </div>
                </div>
                
                <!-- Row 2 -->
                <div class="space-y-1.5">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Nombre Tarea <span class="text-red-500">*</span></label>
                    <input type="text" id="modal-program" class="w-full border border-slate-200 rounded-lg px-3 py-2.5 text-sm font-medium text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="Ej: Video Campa√±a Navidad">
                </div>

                <!-- Row 3 -->
                <div class="space-y-1.5">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Detalles</label>
                    <textarea id="modal-detail" rows="2" class="w-full border border-slate-200 rounded-lg px-3 py-2.5 text-sm text-slate-600 placeholder-slate-400 focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition-all" placeholder="Descripci√≥n breve..."></textarea>
                </div>

                <!-- Row 4 -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Inicio</label>
                        <input type="date" id="modal-date" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">D√≠as</label>
                        <input type="number" id="modal-duration" value="3" min="1" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Prioridad</label>
                        <div class="relative">
                            <select id="modal-priority" class="w-full border border-slate-200 rounded-lg pl-3 pr-8 py-2 text-sm font-medium text-slate-700 bg-white focus:ring-2 focus:ring-indigo-500 outline-none appearance-none cursor-pointer">
                                <option value="Alta">üî¥ Alta</option>
                                <option value="Media" selected>üü° Media</option>
                                <option value="Baja">üü¢ Baja</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeTaskModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-200 rounded-lg transition-colors">Cancelar</button>
                <button onclick="saveTask()" class="px-6 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md hover:shadow-lg transform active:scale-95 transition-all flex items-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="hidden fixed bg-white rounded-lg shadow-xl border border-slate-200 w-48 py-1.5 z-50 ring-1 ring-slate-900/5">
        <button onclick="openTaskModal(state.activeMenuTaskId); document.getElementById('context-menu').classList.add('hidden');" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2.5 transition-colors">
            <i data-lucide="edit-2" class="w-4 h-4 text-slate-400"></i> Editar tarea
        </button>
        <button onclick="duplicateTaskFromMenu()" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2.5 transition-colors">
            <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i> Duplicar tarea
        </button>
        <div class="h-px bg-slate-100 my-1"></div>
        <button onclick="deleteTaskFromMenu()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2.5 transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i> Eliminar tarea
        </button>
    </div>

    <script>
        // --- TOAST SYSTEM ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-emerald-500' : 'bg-slate-800';
            const icon = type === 'success' ? 'check-circle' : 'info';
            toast.className = `toast-enter pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg shadow-slate-200 text-white text-sm font-medium ${colors} min-w-[300px]`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i> ${message}`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- DATA ---
        const INITIAL_TASKS = [
            { id: 1, area: 'AudioVisual', client: 'Scheckers', programType: '', program: 'Video-c√°psula Enero', detail: 'Entrega segunda semana enero', date: '2026-01-06', duration: 7, priority: 'Alta', completed: false, createdAt: 1 },
            { id: 2, area: 'Dise√±o', client: 'Scheckers', programType: '', program: 'Infograf√≠a Enero', detail: 'Entrega segunda semana enero', date: '2026-01-06', duration: 4, priority: 'Alta', completed: false, createdAt: 2 },
            { id: 3, area: 'Dise√±o', client: 'Metlife', programType: '', program: 'BOOK Imprimible', detail: 'Ajustes de jota (Bordes)', date: '2026-01-20', duration: 5, priority: 'Alta', completed: false, createdAt: 3 },
            { id: 4, area: 'Dise√±o', client: 'Metlife', programType: '', program: 'M√≥dulo VENTAS', detail: 'Nuevo Manual', date: '2026-01-26', duration: 7, priority: 'Alta', completed: false, createdAt: 4 },
            { id: 5, area: 'Dise√±o', client: 'Ripley', programType: '', program: 'Pend√≥n Onboarding', detail: 'Gu√≠a centro formaci√≥n', date: '2026-01-12', duration: 3, priority: 'Alta', completed: false, createdAt: 5 },
            { id: 6, area: 'Dise√±o', client: 'Ripley', programType: '', program: 'Poster Tienda', detail: 'Esquema talleres', date: '2026-01-15', duration: 2, priority: 'Media', completed: false, createdAt: 6 },
            { id: 7, area: 'Dise√±o', client: 'Ripley', programType: '', program: 'Infograf√≠a Jecyp', detail: 'Gu√≠a buenas pr√°cticas', date: '2026-01-15', duration: 2, priority: 'Media', completed: false, createdAt: 7 },
            { id: 8, area: 'Dise√±o', client: 'Ripley', programType: '', program: 'Fotos de Equipo', detail: 'Fotos profesionales', date: '2026-01-26', duration: 1, priority: 'Alta', completed: false, createdAt: 8 },
            { id: 9, area: 'AudioVisual', client: 'Ripley', programType: '', program: 'Video Interactivo', detail: 'Guion uso Rposs', date: '2026-01-31', duration: 5, priority: 'Media', completed: false, createdAt: 9 },
            { id: 10, area: 'Dise√±o', client: 'Walmart', programType: 'Onboarding', program: 'Dise√±os Tem√°ticos', detail: 'Campa√±as WhatsApp', date: '2026-03-01', duration: 5, priority: 'Baja', completed: false, createdAt: 10 },
            { id: 11, area: 'Dise√±o', client: 'Equipo XP', programType: 'Transversal', program: 'Saludo Clientes', detail: 'D√≠as festivos', date: '2026-02-01', duration: 3, priority: 'Baja', completed: false, createdAt: 11 },
            { id: 12, area: 'Dise√±o', client: 'Walmart', programType: 'Apertura', program: 'Testimonios Apertura', detail: 'Videos 2026', date: '2026-05-01', duration: 10, priority: 'Baja', completed: false, createdAt: 12 },
            { id: 13, area: 'Dise√±o', client: 'Walmart', programType: 'Apertura', program: 'Presentaciones', detail: 'Actualizaci√≥n dise√±o', date: '2026-01-31', duration: 5, priority: 'Baja', completed: false, createdAt: 13 },
            { id: 14, area: 'AudioVisual', client: 'Walmart', programType: 'Onboarding', program: 'Testimonio OB', detail: 'Experiencia', date: '2026-06-01', duration: 7, priority: 'Baja', completed: false, createdAt: 14 },
            { id: 15, area: 'AudioVisual', client: 'Walmart', programType: 'Onboarding', program: 'Video Bienvenida', detail: 'Visualizaci√≥n programa', date: '2026-11-01', duration: 7, priority: 'Baja', completed: false, createdAt: 15 },
            { id: 16, area: 'AudioVisual', client: 'Parque R.', programType: '', program: 'Video Impacto', detail: 'Semestral', date: '2026-07-01', duration: 10, priority: 'Baja', completed: false, createdAt: 16 },
            { id: 17, area: 'AudioVisual', client: 'Metlife', programType: '', program: 'Video Impacto', detail: 'Cierre con testimonios', date: '2026-11-01', duration: 7, priority: 'Baja', completed: false, createdAt: 17 },
            { id: 18, area: 'Dise√±o', client: 'Ripley', programType: '', program: 'GIFs Fechas', detail: 'Navidad, Fiestas Patrias', date: '2026-03-02', duration: 10, priority: 'Baja', completed: false, createdAt: 18 },
            { id: 19, area: 'AudioVisual', client: 'Ripley', programType: '', program: 'Cierre Trimestre', detail: 'Video indicadores', date: '2026-04-03', duration: 5, priority: 'Baja', completed: false, createdAt: 19 },
            { id: 20, area: 'AudioVisual', client: 'Ripley', programType: '', program: 'Impacto Semestral', detail: 'Motivacional', date: '2026-05-29', duration: 5, priority: 'Baja', completed: false, createdAt: 20 },
            { id: 21, area: 'Dise√±o', client: 'Ripley', programType: '', program: 'Galard√≥n Fin A√±o', detail: 'Reconocimiento tiendas', date: '2026-11-08', duration: 5, priority: 'Baja', completed: false, createdAt: 21 },
            { id: 22, area: 'AudioVisual', client: 'Ripley', programType: '', program: 'Video Cierre A√±o', detail: 'Recopilaci√≥n premios', date: '2026-12-04', duration: 7, priority: 'Baja', completed: false, createdAt: 22 },
            { id: 23, area: 'AudioVisual', client: 'Scheckers', programType: '', program: 'C√°psula Febrero', detail: 'Entrega feb', date: '2026-02-03', duration: 5, priority: 'Media', completed: false, createdAt: 23 },
            { id: 24, area: 'Dise√±o', client: 'Scheckers', programType: '', program: 'Infograf√≠a Febrero', detail: 'Entrega feb', date: '2026-02-03', duration: 3, priority: 'Media', completed: false, createdAt: 24 },
            { id: 25, area: 'Dise√±o', client: 'Walmart', programType: 'Onboarding', program: 'Infograf√≠as OB', detail: 'Nuevo formato', date: '2026-01-26', duration: 5, priority: 'Media', completed: false, createdAt: 25 },
            { id: 26, area: 'Dise√±o', client: 'Walmart', programType: 'Onboarding', program: 'QR Tiendas', detail: 'Im√°genes QR', date: '2026-01-26', duration: 2, priority: 'Media', completed: false, createdAt: 26 },
            { id: 27, area: 'Dise√±o', client: 'Equipo XP', programType: 'Transversal', program: 'XP News', detail: 'Nuevo template', date: '2026-03-01', duration: 3, priority: 'Media', completed: false, createdAt: 27 },
            { id: 28, area: 'Dise√±o', client: 'Walmart', programType: 'Apertura', program: 'Estructura Procesos', detail: 'Revisi√≥n flujograma', date: '2026-01-31', duration: 3, priority: 'Media', completed: false, createdAt: 28 },
            { id: 29, area: 'Dise√±o', client: 'Walmart', programType: 'Apertura', program: 'Videos Testimonios', detail: 'Dise√±o gr√°fica 2025', date: '2026-02-01', duration: 4, priority: 'Media', completed: false, createdAt: 29 },
            { id: 30, area: 'Dise√±o', client: 'Walmart', programType: 'Apertura', program: 'Videos APT', detail: 'Testimonios e hitos', date: '2026-02-01', duration: 4, priority: 'Media', completed: false, createdAt: 30 },
            { id: 31, area: 'Dise√±o', client: 'Equipo XP', programType: 'Transversal', program: 'Taller DEI', detail: 'Dise√±o presentaci√≥n Diversidad e Inclusi√≥n', date: '2026-03-02', duration: 5, priority: 'Media', completed: false, createdAt: 31 },
            { id: 32, area: 'Dise√±o', client: 'Equipo XP', programType: 'Transversal', program: 'Infograf√≠a DJ', detail: 'Instructivo DJ Elearning', date: '2026-02-15', duration: 3, priority: 'Media', completed: false, createdAt: 32 },
            { id: 33, area: 'AudioVisual', client: 'Equipo XP', programType: 'Transversal', program: 'Video DJ', detail: 'Video corto instructivo DJ', date: '2026-02-15', duration: 4, priority: 'Media', completed: false, createdAt: 33 },
            { id: 34, area: 'Dise√±o', client: 'Equipo XP', programType: 'Transversal', program: 'Template Cowork', detail: 'Renovar nueva cara del a√±o', date: '2026-02-15', duration: 3, priority: 'Baja', completed: false, createdAt: 34 },
            { id: 35, area: 'AudioVisual', client: 'Equipo XP', programType: 'Transversal', program: 'Web / Redes', detail: 'Renovar videos equipo y web', date: '2026-06-01', duration: 10, priority: 'Baja', completed: false, createdAt: 35 },
            { id: 36, area: 'AudioVisual', client: 'Ripley', programType: '', program: 'Impacto Anual', detail: 'Video cierre programa, material recopilatorio', date: '2026-11-01', duration: 7, priority: 'Baja', completed: false, createdAt: 36 }
        ];

        let tasks = JSON.parse(localStorage.getItem('creativeTasks_2026_v8')) || INITIAL_TASKS;
        if(tasks.length < 5) tasks = INITIAL_TASKS;

        let state = {
            view: 'grid',
            filterArea: 'Todas',
            filterPriority: 'Todas',
            searchTerm: '',
            sortBy: 'date',
            zoomLevel: 3,
            calendarDate: new Date(2026, 0, 1),
            activeMenuTaskId: null,
            clients: ["Ripley", "Walmart", "Metlife", "Scheckers", "Parque R.", "Equipo XP", "General"],
            programTypes: ["Onboarding", "Apertura", "Transversal", "Cierre", "Otro"]
        };

        const saveTasks = () => localStorage.setItem('creativeTasks_2026_v8', JSON.stringify(tasks));

        // --- HELPERS ---
        const addDays = (dateStr, days) => {
            const date = new Date(dateStr + 'T12:00:00');
            date.setDate(date.getDate() + parseInt(days));
            return date.toISOString().split('T')[0];
        };

        const getDaysDiff = (startStr, endStr) => {
            const d1 = new Date(startStr + 'T12:00:00');
            const d2 = new Date(endStr + 'T12:00:00');
            const diffTime = d2 - d1;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
        };

        const getPriorityColor = (p) => {
            if(p === 'Alta') return 'bg-rose-50 text-rose-700 border-rose-100 ring-1 ring-rose-200';
            if(p === 'Media') return 'bg-amber-50 text-amber-700 border-amber-100 ring-1 ring-amber-200';
            return 'bg-emerald-50 text-emerald-700 border-emerald-100 ring-1 ring-emerald-200';
        };

        const getClientColor = (c) => {
            const safeClient = (c || 'General').toLowerCase();
            if(safeClient.includes('ripley')) return 'bg-violet-600';
            if(safeClient.includes('walmart')) return 'bg-blue-600';
            if(safeClient.includes('metlife')) return 'bg-sky-500';
            if(safeClient.includes('scheckers')) return 'bg-indigo-500';
            if(safeClient.includes('parque')) return 'bg-emerald-600';
            if(safeClient.includes('xp')) return 'bg-pink-500';
            return 'bg-slate-500';
        };

        const getClientBadge = (c) => {
            const safeClient = (c || 'General').toLowerCase();
            if(safeClient.includes('ripley')) return 'bg-violet-50 text-violet-700 ring-1 ring-violet-200';
            if(safeClient.includes('walmart')) return 'bg-blue-50 text-blue-700 ring-1 ring-blue-200';
            if(safeClient.includes('metlife')) return 'bg-sky-50 text-sky-700 ring-1 ring-sky-200';
            if(safeClient.includes('scheckers')) return 'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200';
            if(safeClient.includes('parque')) return 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200';
            if(safeClient.includes('xp')) return 'bg-pink-50 text-pink-700 ring-1 ring-pink-200';
            return 'bg-slate-100 text-slate-700 ring-1 ring-slate-200';
        };

        const getFilteredTasks = () => {
            const filtered = tasks.filter(t => {
                const matchArea = state.filterArea === 'Todas' || t.area === state.filterArea;
                const matchPriority = state.filterPriority === 'Todas' || t.priority === state.filterPriority;
                const search = state.searchTerm.toLowerCase();
                const safeClient = (t.client || '').toLowerCase();
                const safeProgram = (t.program || '').toLowerCase();
                const safeDetail = (t.detail || '').toLowerCase();
                return matchArea && matchPriority && (safeClient.includes(search) || safeProgram.includes(search) || safeDetail.includes(search));
            });
            if (state.sortBy === 'recent') {
                return filtered.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
            }
            return filtered.sort((a,b) => new Date(a.date) - new Date(b.date));
        };

        // --- CORE RENDER ---
        function renderApp() {
            renderHeader();
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            const filtered = getFilteredTasks();
            
            const zoomControl = document.getElementById('zoom-control');
            state.view === 'grid' ? zoomControl.classList.remove('hidden') : zoomControl.classList.add('hidden');

            if(filtered.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 opacity-60"><i data-lucide="ghost" class="w-16 h-16 mb-4"></i><p class="text-lg font-medium">No se encontraron tareas</p></div>`;
            } else {
                if (state.view === 'grid') renderGrid(container, filtered);
                else if (state.view === 'list') renderList(container, filtered);
                else if (state.view === 'calendar') renderCalendar(container, filtered);
                else if (state.view === 'gantt') renderGantt(container, filtered);
            }
            lucide.createIcons();
            updateViewButtons();
        }

        function updateViewButtons() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                btn.classList.add('text-slate-500', 'hover:bg-slate-200');
            });
            const activeBtn = document.getElementById(`btn-${state.view}`);
            activeBtn.classList.remove('text-slate-500', 'hover:bg-slate-200');
            activeBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
        }

        function renderHeader() {
            const filtered = getFilteredTasks();
            const total = filtered.length;
            const alta = filtered.filter(t => t.priority === 'Alta').length;
            const diseno = filtered.filter(t => t.area === 'Dise√±o').length;
            const av = filtered.filter(t => t.area === 'AudioVisual').length;
            
            const stat = (l,v,i,c) => `<div class="flex items-center gap-3 px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl min-w-[140px]"><div class="p-2 rounded-lg ${c} text-white shadow-sm"><i data-lucide="${i}" class="w-4 h-4"></i></div><div><div class="text-xs text-slate-500 font-medium uppercase tracking-wide">${l}</div><div class="text-lg font-bold text-slate-800 leading-none">${v}</div></div></div>`;
            document.getElementById('stats-container').innerHTML = `${stat('Total',total,'list-todo','bg-slate-800')}${stat('Cr√≠ticas',alta,'alert-circle','bg-rose-500')}${stat('Dise√±o',diseno,'palette','bg-indigo-500')}${stat('Video',av,'video','bg-orange-500')}`;
        }

        function renderGrid(container, tasks) {
            let gridCols = "grid-cols-1 md:grid-cols-3";
            const z = parseInt(state.zoomLevel);
            if(z===1) gridCols="grid-cols-1"; else if(z===2) gridCols="grid-cols-1 sm:grid-cols-2"; else if(z===3) gridCols="grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"; else if(z===4) gridCols="grid-cols-1 sm:grid-cols-2 lg:grid-cols-4"; else if(z===5) gridCols="grid-cols-2 sm:grid-cols-3 lg:grid-cols-5";
            
            const gridDiv = document.createElement('div');
            gridDiv.className = `grid gap-6 ${gridCols} w-full content-start`;
            
            tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = "group bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-indigo-100 hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden relative min-h-[200px] cursor-pointer";
                card.onclick = (e) => { if(!e.target.closest('button')) openTaskModal(task.id); };
                
                card.innerHTML = `
                    <div class="h-1.5 w-full ${getClientColor(task.client)}"></div>
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-3">
                             <div class="flex items-center gap-2">
                                <span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold ${getPriorityColor(task.priority)}">${task.priority}</span>
                                ${task.completed ? '<i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-500"></i>' : ''}
                             </div>
                             <div class="flex items-center gap-1">
                                <span class="text-[10px] font-medium text-slate-400 uppercase tracking-wide mr-1">${task.area}</span>
                             </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-1.5 mb-1 flex-wrap">
                                <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">${task.client}</span>
                                ${task.programType ? `<span class="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 border border-slate-200">${task.programType}</span>` : ''}
                            </div>
                            <h2 class="text-base font-bold text-slate-800 leading-snug mb-2 group-hover:text-indigo-600 transition-colors line-clamp-2">${task.program}</h2>
                            <p class="text-xs text-slate-500 leading-relaxed line-clamp-3">${task.detail || ''}</p>
                        </div>
                        <div class="flex items-center justify-between text-xs text-slate-400 mt-4 pt-4 border-t border-slate-50">
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 text-indigo-400"></i> 
                                <span class="font-medium text-slate-600">${new Date(task.date + 'T12:00:00').toLocaleDateString('es-CL')}</span>
                            </div>
                            <span class="font-medium bg-slate-50 px-2 py-0.5 rounded text-slate-500">${task.duration} d√≠as</span>
                        </div>
                    </div>`;
                gridDiv.appendChild(card);
            });
            container.appendChild(gridDiv);
        }

        function renderList(container, tasks) {
            const listDiv = document.createElement('div');
            listDiv.className = "flex flex-col gap-3 w-full";
            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = "group bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-indigo-200 transition-all flex flex-row items-center h-20 overflow-hidden shrink-0 cursor-pointer";
                item.onclick = (e) => { if(!e.target.closest('button') && !e.target.closest('input')) openTaskModal(task.id); };
                item.innerHTML = `
                    <div class="w-1.5 h-full ${getClientColor(task.client)}"></div>
                    <div class="p-4 flex-1 flex flex-row items-center justify-between gap-6">
                        <div class="w-8 flex justify-center">
                             <button onclick="toggleComplete(${task.id})" class="text-slate-300 hover:text-emerald-500 hover:scale-110 transition-all">
                                <i data-lucide="check-circle-2" class="w-5 h-5" ${task.completed ? 'fill="#10b981" stroke="white"' : ''}></i>
                             </button>
                        </div>
                        <div class="min-w-[80px]"><span class="px-2.5 py-1 rounded-full text-[10px] font-bold ${getPriorityColor(task.priority)}">${task.priority}</span></div>
                        <div class="flex-1 min-w-[200px]">
                            <div class="flex items-center gap-2 mb-0.5">
                                <h3 class="text-[10px] font-bold uppercase text-slate-400">${task.client}</h3>
                                ${task.programType ? `<span class="text-[9px] bg-slate-100 px-1.5 rounded text-slate-500 border">${task.programType}</span>` : ''}
                            </div>
                            <div class="text-sm font-bold text-slate-800 ${task.completed ? 'line-through text-slate-400' : ''}">${task.program}</div>
                        </div>
                        <div class="hidden md:flex flex-1 items-center gap-2">
                             <span class="flex items-center w-fit text-[11px] font-medium text-slate-600 bg-slate-50 px-2.5 py-1 rounded-lg border border-slate-100">
                                <i data-lucide="${task.area === 'Dise√±o' ? 'palette' : 'video'}" class="w-3 h-3 mr-1.5 text-slate-400"></i>${task.area}
                            </span>
                        </div>
                        <div class="text-right min-w-[120px]">
                            <div class="flex items-center justify-end text-xs font-medium text-slate-600 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 mr-2 text-indigo-500"></i> ${new Date(task.date + 'T12:00:00').toLocaleDateString('es-CL', {day: 'numeric', month:'short'})}
                            </div>
                        </div>
                    </div>`;
                listDiv.appendChild(item);
            });
            container.appendChild(listDiv);
        }

        function renderCalendar(container, tasks) {
            const wrapper = document.createElement('div');
            wrapper.className = "bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden";
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            wrapper.innerHTML = `
                <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
                    <div class="flex items-center bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
                        <button onclick="changeMonth(-1)" class="p-1.5 hover:bg-slate-50 rounded-md text-slate-500 hover:text-indigo-600"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <span class="px-4 text-sm font-bold text-slate-800 w-40 text-center uppercase tracking-wide">${monthNames[state.calendarDate.getMonth()]} <span class="text-slate-400">${state.calendarDate.getFullYear()}</span></span>
                        <button onclick="changeMonth(1)" class="p-1.5 hover:bg-slate-50 rounded-md text-slate-500 hover:text-indigo-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 border-b border-slate-200 bg-slate-50 sticky top-0 z-10">
                    ${['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'].map(d=>`<div class="py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-widest">${d}</div>`).join('')}
                </div>`;
            
            const gridBody = document.createElement('div');
            gridBody.className = "grid grid-cols-7 bg-slate-50/30";
            
            const year = state.calendarDate.getFullYear(), month = state.calendarDate.getMonth();
            const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
            let startingDay = firstDay.getDay() - 1; if (startingDay === -1) startingDay = 6;
            
            let dayCounter = 1;
            for (let i = 0; i < 42; i++) {
                const cell = document.createElement('div');
                cell.className = "min-h-[140px] border-b border-r border-slate-100/80 p-1.5 flex flex-col gap-1 hover:bg-white transition-colors";
                if (i >= startingDay && dayCounter <= lastDay.getDate()) {
                    let d = dayCounter;
                    let dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                    const isToday = dateStr === new Date().toISOString().split('T')[0];
                    cell.innerHTML = `<div class="flex justify-between items-start mb-1"><span class="text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-700'}">${d}</span></div>`;
                    tasks.filter(t => t.date === dateStr).forEach(t => {
                        const bg = getClientColor(t.client);
                        cell.innerHTML += `<div onclick="openTaskModal(${t.id})" class="group text-[10px] px-2 py-1 rounded-md shadow-sm text-white ${bg} cursor-pointer hover:brightness-110 truncate font-medium" title="${t.program}">${t.completed ? '‚úì ' : ''}${t.program}</div>`;
                    });
                    if(isToday) cell.classList.add('bg-indigo-50/30');
                    dayCounter++;
                } else cell.classList.add("bg-slate-50/50");
                gridBody.appendChild(cell);
            }
            wrapper.appendChild(gridBody);
            container.appendChild(wrapper);
        }

        function renderGantt(container, filteredTasks) {
            container.className = "max-w-7xl mx-auto flex flex-col gap-6 pb-10";
            
            // Editor
            const editorDiv = document.createElement('div');
            editorDiv.className = "bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative h-[450px] shrink-0";
            editorDiv.innerHTML = `
                <div class="px-5 py-3 bg-slate-50 border-b border-slate-200 font-semibold text-slate-700 text-sm flex items-center gap-2"><i data-lucide="table-2" class="w-4 h-4 text-slate-400"></i> Editor de Tareas</div>
                <div class="grid grid-cols-[40px_140px_1fr_110px_70px_110px_40px] bg-slate-50/50 font-bold border-b border-slate-200 text-slate-500 text-[10px] uppercase tracking-wider h-[40px] items-center shrink-0">
                    <div class="border-r h-full flex items-center justify-center">#</div>
                    <div class="px-3 border-r h-full flex items-center">Cliente</div>
                    <div class="px-3 border-r h-full flex items-center">Programa</div>
                    <div class="px-1 border-r h-full flex items-center justify-center">Inicio</div>
                    <div class="px-1 border-r h-full flex items-center justify-center">D√≠as</div>
                    <div class="px-1 h-full flex items-center justify-center">Fin</div><div class="h-full"></div>
                </div>`;
            const editorBody = document.createElement('div');
            editorBody.className = "overflow-y-auto flex-1 bg-white custom-scrollbar";
            filteredTasks.forEach(task => {
                const row = document.createElement('div');
                row.className = `grid grid-cols-[40px_140px_1fr_110px_70px_110px_40px] border-b border-slate-100 hover:bg-slate-50 transition-colors items-center h-[44px] cursor-pointer`;
                row.onclick = (e) => { if(!e.target.closest('button') && !e.target.closest('input')) openTaskModal(task.id); };
                row.innerHTML = `
                    <div class="border-r h-full flex items-center justify-center"><button onclick="toggleComplete(${task.id})" class="text-slate-300 hover:text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4" ${task.completed ? 'fill="#10b981" stroke="white"' : ''}></i></button></div>
                    <div class="border-r h-full px-2 py-1 flex items-center"><div class="w-full h-7 px-2 rounded-md flex items-center justify-center text-[10px] font-bold truncate ${getClientBadge(task.client)}">${task.client}</div></div>
                    <div class="border-r h-full px-3 py-1 flex items-center text-xs font-semibold text-slate-700 truncate">${task.program}</div>
                    <div class="border-r h-full px-1 py-1 flex items-center justify-center text-xs font-mono text-slate-600">${task.date}</div>
                    <div class="border-r h-full px-1 py-1 flex items-center justify-center text-xs font-mono text-slate-600">${task.duration}</div>
                    <div class="h-full px-1 py-1 flex items-center justify-center text-xs font-mono text-slate-500">${addDays(task.date, task.duration)}</div>
                    <div class="h-full flex items-center justify-center"><button onclick="openContextMenu(event, ${task.id})" class="p-1.5 text-slate-400 hover:text-indigo-600"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button></div>`;
                editorBody.appendChild(row);
            });
            editorDiv.appendChild(editorBody);
            container.appendChild(editorDiv);

            // Timeline
            const visualDiv = document.createElement('div');
            visualDiv.className = "bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative h-[500px] shrink-0";
            visualDiv.innerHTML = `<div class="px-5 py-3 bg-slate-50 border-b border-slate-200 font-semibold text-slate-700 text-sm flex items-center gap-2 shrink-0"><i data-lucide="bar-chart-3" class="w-4 h-4 text-slate-400"></i> Cronograma Visual</div>`;
            const flexContainer = document.createElement('div');
            flexContainer.className = "flex flex-1 overflow-hidden";
            
            const leftLabels = document.createElement('div');
            leftLabels.className = "w-48 flex-shrink-0 border-r border-slate-200 bg-white z-20 shadow-[4px_0_10px_-4px_rgba(0,0,0,0.05)] flex flex-col";
            leftLabels.innerHTML = `<div class="h-[40px] border-b border-slate-200 bg-slate-50 flex items-center px-4 text-[10px] uppercase tracking-wider text-slate-500 font-bold shrink-0">Referencia</div>`;
            const labelBody = document.createElement('div');
            labelBody.className = "overflow-hidden flex-1 bg-white pt-0";
            filteredTasks.forEach(task => {
                labelBody.innerHTML += `<div onclick="openTaskModal(${task.id})" class="border-b border-slate-100 px-4 flex items-center text-xs font-medium text-slate-600 hover:bg-slate-50 transition-colors h-[44px] cursor-pointer"><div class="w-2 h-2 rounded-full mr-3 shrink-0 ${getClientColor(task.client).split(' ')[0]} shadow-sm"></div><span class="truncate ${task.completed ? 'text-slate-400 line-through' : ''}">${task.program}</span></div>`;
            });
            leftLabels.appendChild(labelBody);

            const timestamps = filteredTasks.map(t => new Date(t.date+'T12:00:00').getTime());
            const minTs = Math.min(...timestamps);
            const maxTs = Math.max(...filteredTasks.map(t => new Date(addDays(t.date,t.duration)+'T12:00:00').getTime()));
            const startBuffer = new Date(minTs); startBuffer.setDate(startBuffer.getDate()-5);
            const endBuffer = new Date(maxTs); endBuffer.setDate(endBuffer.getDate()+30);
            
            const timelineDays = []; let curr = new Date(startBuffer);
            while(curr<=endBuffer){ timelineDays.push(new Date(curr)); curr.setDate(curr.getDate()+1); }
            const DAY_WIDTH = 44; const contentWidth = timelineDays.length * DAY_WIDTH;

            const timelineDiv = document.createElement('div'); timelineDiv.className = "flex-1 flex flex-col overflow-hidden relative bg-white";
            const scroller = document.createElement('div'); scroller.className = "flex-1 overflow-auto bg-slate-50 relative scroll-smooth custom-scrollbar";
            const contentInner = document.createElement('div'); contentInner.className = "relative min-h-full"; contentInner.style.width = `${contentWidth}px`;

            const timeHeader = document.createElement('div'); timeHeader.className = "sticky top-0 z-30 flex border-b border-slate-200 bg-white h-[40px] shadow-sm";
            timelineDays.forEach(d => {
                const isToday = d.toDateString() === new Date().toDateString();
                timeHeader.innerHTML += `<div class="flex-shrink-0 border-r border-slate-100 flex flex-col justify-center items-center text-[10px] ${isToday?'bg-indigo-50 text-indigo-600 font-bold':'text-slate-400'}" style="width:${DAY_WIDTH}px"><span>${d.toLocaleDateString('es-CL',{weekday:'narrow'})}</span><span>${d.getDate()}</span></div>`;
            });
            contentInner.appendChild(timeHeader);

            const gridBg = document.createElement('div'); gridBg.className = "absolute inset-0 top-[40px] flex pointer-events-none h-full";
            timelineDays.forEach(d => {
                const isToday = d.toDateString() === new Date().toDateString();
                gridBg.innerHTML += `<div class="h-full border-r border-slate-100 box-border flex justify-center ${isToday?'bg-indigo-50/20':''}" style="width:${DAY_WIDTH}px">${isToday?'<div class="w-px h-full bg-indigo-400/50 absolute"></div>':''}</div>`;
            });
            contentInner.appendChild(gridBg);

            const barsContainer = document.createElement('div'); barsContainer.className = "relative z-10";
            const ganttStartTs = startBuffer.getTime();
            filteredTasks.forEach(task => {
                const start = new Date(task.date+'T12:00:00').getTime();
                const diff = start - ganttStartTs;
                const left = Math.ceil(diff/(1000*60*60*24)) * DAY_WIDTH;
                const width = task.duration * DAY_WIDTH;
                const colorClass = task.completed ? 'bg-slate-300 text-slate-500' : `${getClientBadge(task.client).split(' ')[0]} ${getClientBadge(task.client).split(' ')[1]}`;
                barsContainer.innerHTML += `<div class="w-full relative border-b border-slate-100/50 hover:bg-indigo-50/10 transition-colors h-[44px]"><div onclick="openTaskModal(${task.id})" class="absolute top-1/2 -translate-y-1/2 h-7 rounded-md shadow-sm border border-white/20 ring-1 text-xs flex items-center px-2 whitespace-nowrap overflow-hidden cursor-pointer hover:shadow-md hover:scale-[1.01] transition-all ${colorClass}" style="left:${left+2}px;width:${width-4}px" title="${task.program}">${width>30?`<span class="font-bold text-[10px] truncate">${task.program}</span>`:''}</div></div>`;
            });
            contentInner.appendChild(barsContainer);
            
            scroller.appendChild(contentInner); timelineDiv.appendChild(scroller);
            flexContainer.appendChild(leftLabels); flexContainer.appendChild(timelineDiv);
            visualDiv.appendChild(flexContainer); container.appendChild(visualDiv);
        }

        // --- MODAL LOGIC ---
        function openTaskModal(taskId = null) {
            const modal = document.getElementById('task-modal');
            const title = document.getElementById('modal-title');
            
            // Populate Clients
            const clientSelect = document.getElementById('modal-client');
            clientSelect.innerHTML = state.clients.map(c => `<option value="${c}">${c}</option>`).join('');

            // Populate Program Types
            const progList = document.getElementById('program-types-list');
            progList.innerHTML = state.programTypes.map(p => `<option value="${p}">`).join('');
            
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    state.activeMenuTaskId = taskId; // Tracking ID being edited
                    document.getElementById('modal-task-id').value = task.id;
                    title.innerHTML = '<i data-lucide="edit-2" class="w-5 h-5 text-indigo-600"></i> Editar Tarea';
                    
                    document.getElementById('modal-client').value = task.client;
                    document.getElementById('modal-area').value = task.area;
                    document.getElementById('modal-program-type').value = task.programType || '';
                    document.getElementById('modal-program').value = task.program;
                    document.getElementById('modal-detail').value = task.detail || '';
                    document.getElementById('modal-date').value = task.date;
                    document.getElementById('modal-duration').value = task.duration;
                    document.getElementById('modal-priority').value = task.priority;
                }
            } else {
                state.activeMenuTaskId = null;
                document.getElementById('modal-task-id').value = '';
                title.innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Nueva Tarea';
                // Reset fields
                document.getElementById('modal-program').value = '';
                document.getElementById('modal-detail').value = '';
                document.getElementById('modal-program-type').value = '';
                document.getElementById('modal-duration').value = '3';
                document.getElementById('modal-date').valueAsDate = new Date();
                document.getElementById('modal-client').selectedIndex = 0;
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('modal-enter');
                document.getElementById('task-modal-content').classList.add('modal-content-enter');
            }, 10);
            lucide.createIcons();
        }

        function closeTaskModal() {
            const modal = document.getElementById('task-modal');
            modal.classList.remove('modal-enter');
            document.getElementById('task-modal-content').classList.remove('modal-content-enter');
            setTimeout(() => modal.classList.add('hidden'), 200);
            
            // Reset New Client UI if open
            const select = document.getElementById('modal-client').parentElement;
            const input = document.getElementById('modal-new-client');
            select.classList.remove('hidden');
            input.classList.add('hidden');
        }

        function toggleNewClient() {
            const select = document.getElementById('client-select-container');
            const input = document.getElementById('modal-new-client');
            
            if (select.classList.contains('hidden')) {
                select.classList.remove('hidden');
                input.classList.add('hidden');
                input.value = '';
            } else {
                select.classList.add('hidden');
                input.classList.remove('hidden');
                input.focus();
            }
        }

        function saveTask() {
            const idInput = document.getElementById('modal-task-id').value;
            const isEdit = !!idInput;
            
            // Handle Client (Select or New Input)
            let client = document.getElementById('modal-client').value;
            const newClientInput = document.getElementById('modal-new-client');
            if (!newClientInput.classList.contains('hidden') && newClientInput.value.trim() !== '') {
                client = newClientInput.value.trim();
                // Add to persistent clients list if not exists
                if (!state.clients.includes(client)) {
                    state.clients.push(client);
                    // Could save clients list to localStorage here too
                }
            }

            const pType = document.getElementById('modal-program-type').value.trim();
            if(pType && !state.programTypes.includes(pType)) {
                state.programTypes.push(pType);
            }

            const taskData = {
                client: client,
                area: document.getElementById('modal-area').value,
                programType: pType,
                program: document.getElementById('modal-program').value.trim(),
                detail: document.getElementById('modal-detail').value,
                date: document.getElementById('modal-date').value || new Date().toISOString().split('T')[0],
                duration: parseInt(document.getElementById('modal-duration').value) || 1,
                priority: document.getElementById('modal-priority').value,
            };

            if (!taskData.program) {
                alert('Ingrese un nombre para la tarea');
                return;
            }

            if (isEdit) {
                const taskIndex = tasks.findIndex(t => t.id == idInput);
                if (taskIndex > -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                    showToast('Tarea actualizada');
                }
            } else {
                const newTask = {
                    id: Date.now(),
                    ...taskData,
                    completed: false,
                    createdAt: Date.now()
                };
                tasks.push(newTask);
                state.sortBy = 'recent';
                showToast('Tarea creada exitosamente');
            }

            saveTasks();
            closeTaskModal();
            renderApp();
        }

        // Shared Actions
        function handleSearch(val) { state.searchTerm = val; renderApp(); }
        function handleFilterArea(val) { state.filterArea = val; renderApp(); }
        function handleFilterPriority(val) { state.filterPriority = val; renderApp(); }
        function handleSort(val) { state.sortBy = val; renderApp(); }
        function handleZoom(val) { state.zoomLevel = parseInt(val); renderApp(); }
        function setView(mode) { state.view = mode; renderApp(); }
        
        window.changeMonth = function(dir) { state.calendarDate.setMonth(state.calendarDate.getMonth() + dir); renderApp(); };
        window.toggleComplete = function(id) { const t=tasks.find(x=>x.id===id); if(t){t.completed=!t.completed; saveTasks(); renderApp(); if(t.completed) showToast('Tarea completada');} };
        
        window.openContextMenu = function(e, id) { e.stopPropagation(); state.activeMenuTaskId = id; const m=document.getElementById('context-menu'); const r=e.target.getBoundingClientRect(); m.style.top=`${r.bottom + window.scrollY}px`; m.style.left=`${r.left-150}px`; m.classList.remove('hidden'); };
        window.duplicateTaskFromMenu = function() { const t=tasks.find(x=>x.id===state.activeMenuTaskId); if(t){ tasks.push({...t, id:Date.now(), program:t.program+' (Copia)', createdAt:Date.now()}); saveTasks(); state.sortBy='recent'; renderApp(); showToast('Duplicada'); } };
        window.deleteTaskFromMenu = function() { if(confirm('¬øEliminar?')){ tasks=tasks.filter(x=>x.id!==state.activeMenuTaskId); saveTasks(); renderApp(); showToast('Eliminada','info'); } };
        
        document.addEventListener('click', () => document.getElementById('context-menu').classList.add('hidden'));
        
        // Initial Render
        renderApp();
    </script>
</body>
</html>
